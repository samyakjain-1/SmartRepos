name: Daily GitHub Trending Scraper

on:
  schedule:
    # Run daily at 6:00 AM UTC (adjust timezone as needed)
    - cron: '0 6 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  scrape-trending:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ”§ Setup Modelence environment
        run: |
          echo "MODELENCE_CRON_ENABLED=true" >> .modelence.env
          echo "MODELENCE_TELEMETRY_ENABLED=false" >> .modelence.env
          echo "MODELENCE_ENVIRONMENT_ID=${{ secrets.MODELENCE_ENVIRONMENT_ID }}" >> .modelence.env
          echo "MODELENCE_SERVICE_ENDPOINT=${{ secrets.MODELENCE_SERVICE_ENDPOINT }}" >> .modelence.env
          echo "MODELENCE_SERVICE_TOKEN=${{ secrets.MODELENCE_SERVICE_TOKEN }}" >> .modelence.env
          echo "MODELENCE_CONTAINER_ID=${{ secrets.MODELENCE_CONTAINER_ID }}" >> .modelence.env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN_SCRAPING }}" >> .modelence.env
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ•·ï¸ Run trending scraper
        run: |
          echo "ğŸš€ Starting GitHub trending scraping job..."
          echo "ğŸ“… Current time: $(date)"
          chmod +x scripts/scrape-trending-modelence.js
          timeout 600 node scripts/scrape-trending-modelence.js
        env:
          NODE_ENV: production
          TZ: UTC
      
      - name: ğŸ“Š Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scraping-logs-${{ github.run_number }}
          path: |
            .modelence/logs/
            *.log
          retention-days: 7
          if-no-files-found: ignore
      
      - name: ğŸ’¬ Notify on failure
        if: failure()
        run: |
          echo "âŒ GitHub trending scraping job failed!"
          echo "ğŸ“‹ Run ID: ${{ github.run_id }}"
          echo "ğŸ”— Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â° Failed at: $(date)"
      
      - name: âœ… Success notification
        if: success()
        run: |
          echo "ğŸ‰ GitHub trending scraping completed successfully!"
          echo "ğŸ“… Completed at: $(date)" 